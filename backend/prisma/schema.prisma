// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String     @id @default(cuid())
  email     String     @unique
  phone     String?
  password  String
  role      UserRole   @default(CUSTOMER)
  status    UserStatus @default(PENDING)
  riskScore Int        @default(0)
  kycStatus KYCStatus  @default(NOT_STARTED)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Profile information
  profile UserProfile?

  // Relations
  kycVerifications         KYCVerification[]
  documents                Document[]
  transactions             Transaction[]
  counterpartyTransactions Transaction[]     @relation("CounterpartyTransactions")
  amlAlerts                AMLAlert[]
  auditLogs                AuditLog[]
  assignedAlerts           AMLAlert[]        @relation("AssignedAnalyst")

  @@map("users")
}

model UserProfile {
  id          String    @id @default(cuid())
  userId      String    @unique
  firstName   String
  lastName    String
  dateOfBirth DateTime?
  nationality String?
  occupation  String?

  // Address information
  street     String?
  city       String?
  state      String?
  country    String?
  postalCode String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// KYC Verification
model KYCVerification {
  id                 String             @id @default(cuid())
  userId             String
  documentType       DocumentType
  documentNumber     String?
  verificationStatus VerificationStatus @default(PENDING)
  confidenceScore    Int?
  verificationMethod String?
  verifiedAt         DateTime?
  expiresAt          DateTime?
  verificationData   Json               @default("{}")
  createdAt          DateTime           @default(now())

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents         Document[]
  livenessDetection LivenessDetection?

  @@map("kyc_verifications")
}

// Document Storage
model Document {
  id                String       @id @default(cuid())
  userId            String
  kycVerificationId String?
  documentType      DocumentType
  fileName          String
  filePath          String
  fileSize          Int
  mimeType          String
  fileHash          String
  encryptionKeyId   String?
  ocrData           Json         @default("{}")
  aiAnalysis        Json         @default("{}")
  processingStatus  String       @default("pending")
  createdAt         DateTime     @default(now())

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  kycVerification KYCVerification? @relation(fields: [kycVerificationId], references: [id])

  @@map("documents")
}

// Liveness Detection
model LivenessDetection {
  id                String   @id @default(cuid())
  userId            String
  kycVerificationId String   @unique
  sessionId         String
  livenessScore     Float
  faceMatchScore    Float?
  antiSpoofingScore Float
  challenges        Json     @default("[]")
  result            Json     @default("{}")
  videoPath         String?
  createdAt         DateTime @default(now())

  kycVerification KYCVerification @relation(fields: [kycVerificationId], references: [id], onDelete: Cascade)

  @@map("liveness_detections")
}

// Transaction Monitoring
model Transaction {
  id              String          @id @default(cuid())
  userId          String
  transactionType TransactionType
  amount          Decimal         @db.Decimal(15, 2)
  currency        String          @default("INR")
  counterpartyId  String?
  description     String?
  transactionTime DateTime        @default(now())
  riskScore       Int             @default(0)
  amlStatus       AMLStatus       @default(CLEAR)
  metadata        Json            @default("{}")
  createdAt       DateTime        @default(now())

  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  counterparty User?      @relation("CounterpartyTransactions", fields: [counterpartyId], references: [id])
  amlAlerts    AMLAlert[]

  @@map("transactions")
}

// AML Alerts
model AMLAlert {
  id              String        @id @default(cuid())
  userId          String
  transactionId   String?
  alertType       String
  severity        AlertSeverity @default(MEDIUM)
  status          AlertStatus   @default(OPEN)
  triggeredRules  Json          @default("[]")
  riskFactors     Json          @default("{}")
  assignedTo      String?
  resolvedAt      DateTime?
  resolutionNotes String?
  falsePositive   Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction  Transaction? @relation(fields: [transactionId], references: [id])
  assignedUser User?        @relation("AssignedAnalyst", fields: [assignedTo], references: [id])

  @@map("aml_alerts")
}

// Compliance Rules
model ComplianceRule {
  id           String   @id @default(cuid())
  ruleName     String   @unique
  ruleType     String
  conditions   Json
  actions      Json
  priority     Int      @default(1)
  isActive     Boolean  @default(true)
  jurisdiction String   @default("IN")
  createdBy    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("compliance_rules")
}

// Audit Trail
model AuditLog {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  action     String
  actorId    String?
  actorType  String?
  changes    Json     @default("{}")
  metadata   Json     @default("{}")
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  actor User? @relation(fields: [actorId], references: [id])

  @@map("audit_logs")
}

// Risk Scoring Cache (for Redis integration)
model RiskScore {
  id           String   @id @default(cuid())
  userId       String   @unique
  currentScore Int
  factors      Json     @default("{}")
  lastUpdated  DateTime @default(now())
  expiresAt    DateTime

  @@map("risk_scores")
}

// Compliance Reports
model ComplianceReport {
  id           String       @id @default(cuid())
  reportType   ReportType
  title        String
  description  String?
  parameters   Json         @default("{}")
  generatedBy  String
  generatedAt  DateTime     @default(now())
  status       ReportStatus @default(GENERATING)
  filePath     String?
  fileSize     Int?
  jurisdiction String       @default("IN")

  @@map("compliance_reports")
}

// Enums
enum UserRole {
  CUSTOMER
  ANALYST
  COMPLIANCE_OFFICER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum KYCStatus {
  NOT_STARTED
  IN_PROGRESS
  PENDING_REVIEW
  APPROVED
  REJECTED
  EXPIRED
}

enum DocumentType {
  PAN
  AADHAAR
  DRIVERS_LICENSE
  PASSPORT
  VOTER_ID
}

enum VerificationStatus {
  PENDING
  IN_PROGRESS
  VERIFIED
  FAILED
  EXPIRED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
  PAYMENT
  REFUND
}

enum AMLStatus {
  CLEAR
  FLAGGED
  UNDER_REVIEW
  BLOCKED
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AlertStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  FALSE_POSITIVE
  ESCALATED
}

enum ReportType {
  KYC_SUMMARY
  AML_ALERTS
  TRANSACTION_ANALYSIS
  COMPLIANCE_AUDIT
  REGULATORY_FILING
}

enum ReportStatus {
  GENERATING
  COMPLETED
  FAILED
}
